<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - JSON Folder Manager</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --line: #d1d5db;
      --accent: #0f766e;
      --accent-hover: #115e59;
      --danger: #b91c1c;
      --danger-hover: #991b1b;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 24px;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .muted {
      color: var(--muted);
      font-size: 0.92rem;
    }

    .row {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    input {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px;
      font: inherit;
    }

    button {
      border: 0;
      border-radius: 8px;
      padding: 10px 12px;
      font: inherit;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status {
      margin-top: 8px;
      min-height: 20px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .status.error {
      color: var(--danger);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.92rem;
    }

    th, td {
      border-bottom: 1px solid var(--line);
      text-align: left;
      padding: 10px 8px;
      vertical-align: top;
    }

    th {
      background: #f9fafb;
      font-weight: 700;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="panel">
      <h1>Admin JSON Folder Manager</h1>
      <p class="muted">Securely view and delete `generate_*` folders inside `excel/json`.</p>
    </section>

    <section id="loginPanel" class="panel hidden">
      <h2>Admin Login</h2>
      <div class="row">
        <label for="username">Username</label>
        <input id="username" type="text" autocomplete="username">
      </div>
      <div class="row">
        <label for="password">Password</label>
        <input id="password" type="password" autocomplete="current-password">
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button id="loginBtn" class="btn-primary" type="button">Login</button>
      </div>
      <div id="loginStatus" class="status"></div>
    </section>

    <section id="adminPanel" class="panel hidden">
      <div class="actions">
        <button id="refreshBtn" class="btn-primary" type="button">Refresh</button>
        <button id="logoutBtn" type="button">Logout</button>
      </div>
      <div id="adminStatus" class="status"></div>
      <input id="folderSourceInput" class="hidden" type="file" accept=".xlsx,.xls,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
      <table>
        <thead>
          <tr>
            <th>Folder</th>
            <th>Mode</th>
            <th>JSON URL</th>
            <th>Modified</th>
            <th>Files</th>
            <th>Subfolders</th>
            <th>Size (MB)</th>
            <th>Rows</th>
            <th>Municipalities</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="folderRows"></tbody>
      </table>
    </section>
  </main>

  <script>
    const loginPanel = document.getElementById("loginPanel");
    const adminPanel = document.getElementById("adminPanel");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const loginStatus = document.getElementById("loginStatus");
    const refreshBtn = document.getElementById("refreshBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminStatus = document.getElementById("adminStatus");
    const folderSourceInput = document.getElementById("folderSourceInput");
    const folderRows = document.getElementById("folderRows");
    let pendingFolderUpload = "";

    function setStatus(el, message, isError) {
      el.textContent = message || "";
      el.classList.toggle("error", Boolean(isError));
    }

    function formatMb(bytes) {
      const mb = (Number(bytes || 0) / (1024 * 1024));
      return mb.toFixed(2);
    }

    function formatTime(ms) {
      if (!ms) return "N/A";
      const d = new Date(ms);
      if (Number.isNaN(d.getTime())) return "N/A";
      return d.toLocaleString();
    }

    function maskUrl(url) {
      const value = String(url || "");
      if (!value) return "";
      if (value.length <= 48) return value;
      return `${value.slice(0, 32)}...${value.slice(-12)}`;
    }

    async function copyText(text) {
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        setStatus(adminStatus, "URL copied to clipboard.");
      } catch (_e) {
        setStatus(adminStatus, "Copy failed. Please copy manually.", true);
      }
    }

    function showLogin() {
      loginPanel.classList.remove("hidden");
      adminPanel.classList.add("hidden");
    }

    function showAdmin() {
      loginPanel.classList.add("hidden");
      adminPanel.classList.remove("hidden");
    }

    async function requestJson(url, options) {
      const response = await fetch(url, options);
      const payload = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(payload.error || `Request failed (${response.status})`);
      }
      return payload;
    }

    async function uploadFolderSource(folderName) {
      const file = folderSourceInput.files && folderSourceInput.files[0];
      if (!file) {
        setStatus(adminStatus, "Please select a source file first.", true);
        return;
      }
      const formData = new FormData();
      formData.append("sourceFile", file);
      setStatus(adminStatus, `Uploading source for ${folderName}...`);
      try {
        const response = await fetch(`/admin/api/folders/${encodeURIComponent(folderName)}/source/upload`, {
          method: "POST",
          body: formData
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.error || `Upload failed (${response.status})`);
        }
        folderSourceInput.value = "";
        pendingFolderUpload = "";
        setStatus(adminStatus, payload.message || `Source updated for ${folderName}.`);
        await loadFolders();
      } catch (error) {
        setStatus(adminStatus, error.message, true);
      }
    }

    async function checkStatus() {
      try {
        const payload = await requestJson("/admin/api/status");
        if (!payload.enabled) {
          showLogin();
          setStatus(loginStatus, "Admin auth is disabled in server config.", true);
          loginBtn.disabled = true;
          return;
        }
        if (payload.authenticated) {
          showAdmin();
          await loadFolders();
          return;
        }
        showLogin();
      } catch (error) {
        showLogin();
        setStatus(loginStatus, error.message, true);
      }
    }

    async function login() {
      loginBtn.disabled = true;
      setStatus(loginStatus, "Logging in...");
      try {
        await requestJson("/admin/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: usernameInput.value,
            password: passwordInput.value
          })
        });
        passwordInput.value = "";
        showAdmin();
        setStatus(adminStatus, "Authenticated.");
        await loadFolders();
      } catch (error) {
        setStatus(loginStatus, error.message, true);
      } finally {
        loginBtn.disabled = false;
      }
    }

    async function logout() {
      try {
        await requestJson("/admin/api/logout", { method: "POST" });
      } catch (_error) {
        // ignore
      }
      showLogin();
      folderRows.innerHTML = "";
      setStatus(loginStatus, "Logged out.");
    }

    async function loadFolders() {
      setStatus(adminStatus, "Loading folders...");
      try {
        const payload = await requestJson("/admin/api/folders");
        const folders = Array.isArray(payload.folders) ? payload.folders : [];
        if (!folders.length) {
          folderRows.innerHTML = `<tr><td colspan="10">No generate folders found.</td></tr>`;
          setStatus(adminStatus, "No folders.");
          return;
        }

        folderRows.innerHTML = folders.map((f) => {
          const active = f.activeJob ? " (active job)" : "";
          const isJsonFolder = String(f.outputMode || "") === "json";
          const jsonUrl = f.jsonUrlTemplate
            ? `${window.location.origin}${f.jsonUrlTemplate}`
            : "";
          const sampleUrl = f.sampleUrl
            ? `${window.location.origin}${f.sampleUrl}`
            : "";
          return `
            <tr>
              <td>${f.name}${active}</td>
              <td>${f.outputMode || "N/A"}</td>
              <td>
                ${jsonUrl
                  ? `<div>${maskUrl(jsonUrl)}</div>
                     <div class="actions">
                       <button type="button" data-action="copy-url" data-url="${jsonUrl}">Copy</button>
                       <a href="${sampleUrl || jsonUrl}" target="_blank" rel="noopener noreferrer">Open</a>
                     </div>`
                  : "N/A"}
              </td>
              <td>${formatTime(f.modifiedAt)}</td>
              <td>${Number(f.fileCount || 0).toLocaleString()}</td>
              <td>${Number(f.dirCount || 0).toLocaleString()}</td>
              <td>${formatMb(f.sizeBytes)}</td>
              <td>${f.rowCount == null ? "N/A" : Number(f.rowCount).toLocaleString()}</td>
              <td>${f.municipalityCount == null ? "N/A" : Number(f.municipalityCount).toLocaleString()}</td>
              <td>
                <div class="actions">
                  <button class="btn-primary" type="button" data-action="upload-source" data-folder="${f.name}" ${f.activeJob || !isJsonFolder ? "disabled" : ""}>Upload Source</button>
                  <button type="button" data-action="refresh-caches" data-folder="${f.name}" ${f.activeJob || !isJsonFolder ? "disabled" : ""}>Refresh Caches</button>
                  <button type="button" data-action="rotate-token" data-folder="${f.name}" ${f.activeJob || !isJsonFolder ? "disabled" : ""}>Rotate Token</button>
                  <button type="button" data-action="revoke-token" data-folder="${f.name}" ${f.activeJob || !isJsonFolder ? "disabled" : ""}>Revoke Token</button>
                  <button class="btn-danger" type="button" data-action="delete-folder" data-folder="${f.name}" ${f.activeJob ? "disabled" : ""}>Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join("");
        setStatus(adminStatus, `Loaded ${folders.length} folder(s).`);
      } catch (error) {
        if (/Unauthorized/i.test(error.message)) {
          showLogin();
          setStatus(loginStatus, "Session expired. Login again.", true);
          return;
        }
        setStatus(adminStatus, error.message, true);
      }
    }

    async function deleteFolder(folderName) {
      const confirmText = window.prompt(`Type the folder name to confirm deletion:\n${folderName}`);
      if (confirmText !== folderName) return;

      setStatus(adminStatus, `Deleting ${folderName}...`);
      try {
        await requestJson(`/admin/api/folders/${encodeURIComponent(folderName)}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ confirm: folderName })
        });
        setStatus(adminStatus, `Deleted ${folderName}.`);
        await loadFolders();
      } catch (error) {
        setStatus(adminStatus, error.message, true);
      }
    }

    async function refreshCaches(folderName) {
      setStatus(adminStatus, `Refreshing ${folderName}...`);
      try {
        const payload = await requestJson(`/admin/api/folders/${encodeURIComponent(folderName)}/refresh-caches`, {
          method: "POST"
        });
        setStatus(adminStatus, payload.message || `Refreshed ${folderName}.`);
        await loadFolders();
      } catch (error) {
        setStatus(adminStatus, error.message, true);
      }
    }

    async function rotateToken(folderName) {
      setStatus(adminStatus, `Rotating token for ${folderName}...`);
      try {
        const payload = await requestJson(`/admin/api/folders/${encodeURIComponent(folderName)}/rotate-token`, {
          method: "POST"
        });
        setStatus(adminStatus, payload.message || `Token rotated for ${folderName}.`);
        await loadFolders();
      } catch (error) {
        setStatus(adminStatus, error.message, true);
      }
    }

    async function revokeToken(folderName) {
      setStatus(adminStatus, `Revoking token for ${folderName}...`);
      try {
        const payload = await requestJson(`/admin/api/folders/${encodeURIComponent(folderName)}/revoke-token`, {
          method: "POST"
        });
        setStatus(adminStatus, payload.message || `Token revoked for ${folderName}.`);
        await loadFolders();
      } catch (error) {
        setStatus(adminStatus, error.message, true);
      }
    }

    loginBtn.addEventListener("click", login);
    refreshBtn.addEventListener("click", loadFolders);
    logoutBtn.addEventListener("click", logout);
    folderSourceInput.addEventListener("change", () => {
      if (!pendingFolderUpload) return;
      uploadFolderSource(pendingFolderUpload);
    });

    folderRows.addEventListener("click", (event) => {
      const btn = event.target.closest("button[data-folder][data-action]");
      const copyBtn = event.target.closest("button[data-action=\"copy-url\"][data-url]");
      if (copyBtn) {
        copyText(copyBtn.dataset.url);
        return;
      }
      if (!btn) return;
      const folderName = btn.dataset.folder;
      const action = btn.dataset.action;
      if (action === "upload-source") {
        pendingFolderUpload = folderName;
        folderSourceInput.click();
        return;
      }
      if (action === "refresh-caches") {
        refreshCaches(folderName);
        return;
      }
      if (action === "rotate-token") {
        rotateToken(folderName);
        return;
      }
      if (action === "revoke-token") {
        revokeToken(folderName);
        return;
      }
      if (action === "delete-folder") {
        deleteFolder(folderName);
      }
    });

    passwordInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") login();
    });

    checkStatus();
  </script>
</body>
</html>
