<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Municipality Workbook ZIP Generator</title>
  <style>
    :root {
      --bg-start: #f4f7ff;
      --bg-end: #e8fff5;
      --panel: #ffffff;
      --text: #1a2332;
      --muted: #5f6f86;
      --accent: #006c67;
      --accent-hover: #005652;
      --danger: #b00020;
      --ring: rgba(0, 108, 103, 0.2);
      --shadow: 0 18px 38px rgba(8, 31, 58, 0.14);
      --radius: 18px;
      --font: "Segoe UI", "Noto Sans", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font);
      background:
        radial-gradient(circle at 20% 20%, rgba(0, 108, 103, 0.12), transparent 48%),
        radial-gradient(circle at 85% 15%, rgba(34, 98, 182, 0.13), transparent 40%),
        linear-gradient(140deg, var(--bg-start), var(--bg-end));
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 20px;
    }

    .panel {
      width: min(720px, 100%);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: clamp(1.5rem, 3vw, 2rem);
      line-height: 1.2;
    }

    p {
      margin: 0 0 22px;
      color: var(--muted);
    }

    .upload-form {
      display: grid;
      gap: 14px;
    }

    .file-label {
      border: 2px dashed #aac8d7;
      border-radius: 14px;
      padding: 26px 18px;
      text-align: center;
      transition: border-color 0.2s, background-color 0.2s;
      background: #f9fcff;
    }

    .file-label:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--ring);
      background: #f3fffc;
    }

    input[type="file"] {
      width: 100%;
      font-size: 0.95rem;
      color: var(--text);
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field label {
      font-size: 0.92rem;
      color: #314864;
      font-weight: 600;
    }

    select {
      width: 100%;
      border: 1px solid #b7c9df;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      color: var(--text);
      background: #fff;
      outline: none;
    }

    input[type="number"] {
      width: 100%;
      border: 1px solid #b7c9df;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      color: var(--text);
      background: #fff;
      outline: none;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--ring);
    }


    button {
      border: 0;
      border-radius: 12px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      padding: 13px 18px;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }

    button:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      transform: none;
    }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .cancel-btn {
      background: #b00020;
      display: none;
    }

    .cancel-btn:hover:not(:disabled) {
      background: #8d001a;
    }

    .status {
      margin-top: 16px;
      min-height: 24px;
      font-size: 0.95rem;
      color: var(--muted);
      word-break: break-word;
    }

    .status.error {
      color: var(--danger);
    }

    .progress {
      margin-top: 12px;
      display: none;
    }

    .progress-track {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: #dfe8f5;
      overflow: hidden;
    }

    .progress-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #0a9f90, #1f7dd5);
      transition: width 0.25s ease;
    }

    .progress-text {
      margin-top: 6px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .tracker {
      margin-top: 4px;
      font-size: 0.9rem;
      color: #314864;
      min-height: 20px;
    }

    .result {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 10px;
      background: #edfffa;
      border: 1px solid #b6ede1;
      display: none;
    }

    .result a {
      color: #005a8f;
      font-weight: 600;
      text-decoration: none;
    }

    .result a:hover {
      text-decoration: underline;
    }

    .stats {
      margin-top: 10px;
      max-height: 220px;
      overflow: auto;
      border: 1px solid #cbe6de;
      border-radius: 8px;
      padding: 8px;
      background: #ffffff;
      font-size: 0.9rem;
      line-height: 1.35;
    }

  </style>
</head>
<body>
  <main class="panel">
    <h1>Roster List Partition</h1>
    <p>Upload an Excel file (.xlsx or .xls).</p>

    <form id="uploadForm" class="upload-form">
      <label class="file-label" for="excelFile">
        <input id="excelFile" name="excelFile" type="file" accept=".xlsx,.xls,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
      </label>
      <div class="field">
        <label for="workbookMode">Workbook Mode</label>
        <select id="workbookMode" name="workbookMode" required>
          <option value="single" selected>Single Workbook</option>
          <option value="multiple">Multiple Workbook</option>
          <option value="split">Split Workbook</option>
        </select>
      </div>
      <div id="splitCountField" class="field" style="display: none;">
        <label for="splitCount">Split Count (number of output workbooks)</label>
        <input id="splitCount" name="splitCount" type="number" min="2" max="100" step="1" value="2">
      </div>
      <div class="actions">
        <button id="submitBtn" type="submit" data-output-mode="zip">Generate ZIP</button>
        <button id="jsonBtn" type="submit" data-output-mode="json" style="display: none;">Generate JSON Link</button>
        <button id="cancelBtn" class="cancel-btn" type="button">Cancel</button>
      </div>
    </form>

    <div id="status" class="status"></div>
    <div id="progress" class="progress">
      <div class="progress-track">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div id="progressText" class="progress-text">0%</div>
      <div id="trackerText" class="tracker"></div>
    </div>
    <div id="result" class="result"></div>
  </main>

  <script>
    const form = document.getElementById("uploadForm");
    const fileInput = document.getElementById("excelFile");
    const workbookModeInput = document.getElementById("workbookMode");
    const splitCountField = document.getElementById("splitCountField");
    const splitCountInput = document.getElementById("splitCount");
    const submitBtn = document.getElementById("submitBtn");
    const jsonBtn = document.getElementById("jsonBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const statusEl = document.getElementById("status");
    const progressEl = document.getElementById("progress");
    const progressFillEl = document.getElementById("progressFill");
    const progressTextEl = document.getElementById("progressText");
    const trackerTextEl = document.getElementById("trackerText");
    const resultEl = document.getElementById("result");
    let activeJobId = null;
    const VERCEL_SAFE_UPLOAD_LIMIT_BYTES = 4 * 1024 * 1024;

    function isLikelyVercelHost() {
      return /\.vercel\.app$/i.test(window.location.hostname || "");
    }

    function formatBytes(bytes) {
      const mb = Number(bytes || 0) / (1024 * 1024);
      return `${mb.toFixed(2)} MB`;
    }

    function toggleSplitCountField() {
      const isSplit = String(workbookModeInput.value || "").toLowerCase() === "split";
      const isMultiple = String(workbookModeInput.value || "").toLowerCase() === "multiple";
      splitCountField.style.display = isSplit ? "grid" : "none";
      jsonBtn.style.display = isMultiple ? "inline-block" : "none";
    }

    function isExcelFile(file) {
      if (!file) return false;
      const excelExtensions = [".xlsx", ".xls"];
      const lowerName = file.name.toLowerCase();
      return excelExtensions.some((ext) => lowerName.endsWith(ext));
    }

    function setStatus(message, isError) {
      statusEl.textContent = message || "";
      statusEl.classList.toggle("error", Boolean(isError));
    }

    function setProgress(percent, message) {
      const value = Math.max(0, Math.min(100, Number(percent) || 0));
      progressEl.style.display = "block";
      progressFillEl.style.width = `${value}%`;
      progressTextEl.textContent = `${value}%${message ? ` - ${message}` : ""}`;
    }

    function hideProgress() {
      progressEl.style.display = "none";
      progressFillEl.style.width = "0%";
      progressTextEl.textContent = "0%";
      trackerTextEl.textContent = "";
    }

    function setJobRunning(jobId) {
      activeJobId = jobId;
      cancelBtn.style.display = "inline-block";
      cancelBtn.disabled = false;
    }

    function clearJobRunning() {
      activeJobId = null;
      cancelBtn.style.display = "none";
      cancelBtn.disabled = false;
    }

    function maskUrl(url) {
      const value = String(url || "");
      if (!value) return "";
      if (value.length <= 56) return value;
      return `${value.slice(0, 36)}...${value.slice(-14)}`;
    }

    async function copyText(text) {
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        setStatus("URL copied to clipboard.");
      } catch (_error) {
        setStatus("Copy failed. Please copy manually.", true);
      }
    }

    async function pollJob(jobId) {
      let failures = 0;
      while (true) {
        let response;
        let payload;

        try {
          response = await fetch(`/progress/${encodeURIComponent(jobId)}`);
          payload = await response.json();
          failures = 0;
        } catch (_error) {
          failures += 1;
          if (failures >= 20) {
            throw new Error("Connection lost while checking progress.");
          }
          setProgress(0, "Reconnecting...");
          await new Promise((resolve) => setTimeout(resolve, 1000));
          continue;
        }

        if (!response.ok) {
          throw new Error(payload.error || "Failed to read job progress.");
        }

        setProgress(payload.progress, payload.message);
        if (payload.currentMunicipality) {
          const workbookPartText = payload.currentWorkbookPart
            ? ` | Workbook part: ${payload.currentWorkbookPart}`
            : "";
          trackerTextEl.textContent =
            `Municipality: ${payload.currentMunicipality}${workbookPartText} | Municipality rows: ${Number(payload.currentMunicipalityRows || 0).toLocaleString()} | Total rows: ${Number(payload.processedRows || 0).toLocaleString()}`;
        }

        if (payload.status === "completed") {
          return payload.result;
        }
        if (payload.status === "cancelled") {
          throw new Error("Job cancelled.");
        }
        if (payload.status === "failed") {
          throw new Error(payload.error || "Conversion failed.");
        }

        await new Promise((resolve) => setTimeout(resolve, 800));
      }
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      resultEl.style.display = "none";
      resultEl.innerHTML = "";
      hideProgress();

      const file = fileInput.files[0];
      const workbookMode = String(workbookModeInput.value || "").toLowerCase();
      const submitter = event.submitter;
      const outputMode = submitter && submitter.dataset && submitter.dataset.outputMode === "json"
        ? "json"
        : "zip";
      if (!file) {
        setStatus("Please select an Excel file.", true);
        return;
      }
      if (!isExcelFile(file)) {
        setStatus("Invalid file type. Please upload only .xlsx or .xls files.", true);
        return;
      }
      if (isLikelyVercelHost() && file.size > VERCEL_SAFE_UPLOAD_LIMIT_BYTES) {
        setStatus(
          `File is too large for Vercel serverless upload limit (${formatBytes(file.size)} selected). Use a file under ${formatBytes(VERCEL_SAFE_UPLOAD_LIMIT_BYTES)} or deploy this backend on a host without this limit.`,
          true
        );
        return;
      }
      const splitCount = Number(splitCountInput.value);
      if (!["single", "multiple", "split"].includes(workbookMode)) {
        setStatus("Invalid workbook mode. Choose Single Workbook, Multiple Workbook, or Split Workbook.", true);
        return;
      }
      if (workbookMode === "split" && (!Number.isInteger(splitCount) || splitCount < 2 || splitCount > 100)) {
        setStatus("Split Count must be an integer from 2 to 100.", true);
        return;
      }
      if (outputMode === "json" && workbookMode !== "multiple") {
        setStatus("Generate JSON Link is only available in Multiple Workbook mode.", true);
        return;
      }

      const formData = new FormData();
      formData.append("excelFile", file);
      formData.append("workbookMode", workbookMode);
      formData.append("outputMode", outputMode);
      if (workbookMode === "split") {
        formData.append("splitCount", String(splitCount));
      }

      submitBtn.disabled = true;
      jsonBtn.disabled = true;
      setStatus(outputMode === "json" ? "Uploading file for JSON link..." : "Uploading file. Please wait...");
      setProgress(2, "Starting...");

      try {
        const response = await fetch("/upload", {
          method: "POST",
          body: formData
        });
        const contentType = response.headers.get("content-type") || "";
        let payload = null;
        let rawText = "";

        if (contentType.includes("application/json")) {
          payload = await response.json();
        } else {
          rawText = await response.text();
        }

        if (!response.ok) {
          const isPayloadTooLarge = response.status === 413 || /FUNCTION_PAYLOAD_TOO_LARGE/i.test(rawText);
          if (isPayloadTooLarge) {
            setStatus(
              `Upload exceeds Vercel serverless payload limit. Use a file under ${formatBytes(VERCEL_SAFE_UPLOAD_LIMIT_BYTES)} or move backend processing to a non-serverless host.`,
              true
            );
            return;
          }
          const message =
            (payload && payload.error) ||
            rawText ||
            `Upload failed with status ${response.status}.`;
          setStatus(message, true);
          return;
        }

        if (!payload) {
          setStatus("Server response is not valid JSON.", true);
          return;
        }

        if (!payload.jobId) {
          setStatus("Missing job ID from server.", true);
          return;
        }

        setJobRunning(payload.jobId);
        setStatus("Converting file. Please wait...");
        const result = await pollJob(payload.jobId);
        setStatus(
          result.message
          || (result.outputMode === "json" ? "JSON link generated successfully." : "ZIP generated successfully.")
        );
        const fileUrl = result.downloadUrl ? `${window.location.origin}${result.downloadUrl}` : "";
        const jsonTemplateUrl = result.jsonUrlTemplate
          ? `${window.location.origin}${result.jsonUrlTemplate}`
          : "";
        const jsonSampleUrl = result.sampleUrl
          ? `${window.location.origin}${result.sampleUrl}`
          : "";
        const stats = Array.isArray(result.municipalityStats) ? result.municipalityStats : [];
        const statsHtml = stats
          .map((item) => `${item.municipality}: ${Number(item.rows || 0).toLocaleString()}`)
          .join("<br>");
        const splitSummary = result.splitWorkbookSummary;
        const splitList = splitSummary && Array.isArray(splitSummary.municipalitiesPerWorkbook)
          ? splitSummary.municipalitiesPerWorkbook
            .map((count, idx) => `Part ${idx + 1}: ${count}`)
            .join(", ")
          : "";
        const splitSummaryLine = splitSummary
          ? `<small>Split municipalities: total=${splitSummary.totalMunicipalities}, parts=${splitSummary.splitCount}. ${splitList}</small><br>`
          : "";

        if (result.outputMode === "json") {
          const expiryText = result.urlExpiresAt
            ? new Date(result.urlExpiresAt).toLocaleString()
            : "N/A";
          resultEl.innerHTML = `
            <strong>Generated JSON Link:</strong>
            <br>
            <small>Output folder: ${result.outputFolder || "N/A"}</small>
            <br>
            <small>Total rows scanned: ${result.rowCount}</small>
            <br>
            <small>Municipalities found: ${result.municipalityCount || 0}</small>
            <br>
            <small>Workbook mode: ${result.workbookMode || "N/A"}</small>
            <br>
            <small>Split by: ${result.splitBy || "N/A"}</small>
            <br>
            <small>URL expires: ${expiryText}</small>
            <br>
            <small>Template URL: ${jsonTemplateUrl ? maskUrl(jsonTemplateUrl) : "N/A"} ${jsonTemplateUrl ? `<button type="button" data-action="copy-url" data-url="${jsonTemplateUrl}">Copy</button>` : ""}</small>
            <br>
            <small>Sample URL: ${jsonSampleUrl ? `${maskUrl(jsonSampleUrl)} <button type="button" data-action="copy-url" data-url="${jsonSampleUrl}">Copy</button> <a href="${jsonSampleUrl}" target="_blank" rel="noopener noreferrer">Open</a>` : "N/A"}</small>
            <div class="stats">${statsHtml || "No municipality stats available."}</div>
          `;
        } else {
          resultEl.innerHTML = `
            <strong>Generated ZIP File:</strong>
            <br>
            <small>Output folder: ${result.outputFolder || "N/A"}</small>
            <br>
            <small>Total rows processed: ${result.rowCount}</small>
            <br>
            <small>Total workbooks: ${result.fileCount || 0}</small>
            <br>
            <small>Workbook mode: ${result.workbookMode || "N/A"}</small>
            <br>
            ${splitSummaryLine}
            <small>Split by: ${result.splitBy || "N/A"}</small>
            <br>
            <a href="${fileUrl}" download="${result.outputFileName || "output.zip"}">Download ${result.outputFileName || "generated.zip"}</a>
            <div class="stats">${statsHtml || "No municipality stats available."}</div>
          `;
        }
        resultEl.style.display = "block";
      } catch (error) {
        if (error.message === "Job cancelled.") {
          setStatus("Job cancelled.");
        } else {
          setStatus(`Process error: ${error.message}`, true);
        }
        hideProgress();
      } finally {
        clearJobRunning();
        submitBtn.disabled = false;
        jsonBtn.disabled = false;
      }
    });

    cancelBtn.addEventListener("click", async () => {
      if (!activeJobId) return;
      cancelBtn.disabled = true;
      setStatus("Cancelling job...");
      try {
        await fetch(`/cancel/${encodeURIComponent(activeJobId)}`, { method: "POST" });
      } catch (_error) {
        setStatus("Cancel request failed, but job may still stop shortly.", true);
      }
    });

    window.addEventListener("beforeunload", () => {
      if (!activeJobId) return;
      try {
        navigator.sendBeacon(`/cancel/${encodeURIComponent(activeJobId)}`, "");
      } catch (_error) {
        // noop
      }
    });

    workbookModeInput.addEventListener("change", toggleSplitCountField);
    resultEl.addEventListener("click", (event) => {
      const btn = event.target.closest("button[data-action=\"copy-url\"][data-url]");
      if (!btn) return;
      copyText(btn.dataset.url);
    });
    toggleSplitCountField();
  </script>
</body>
</html>
